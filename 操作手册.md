# AI换脸工具 操作手册

## 目录
1. [环境准备](#环境准备)
2. [安装指南](#安装指南)
3. [模型下载](#模型下载)
4. [基础使用](#基础使用)
5. [高级功能](#高级功能)
6. [配置说明](#配置说明)
7. [故障排除](#故障排除)
8. [性能优化](#性能优化)

## 环境准备

### 系统要求
- **操作系统**: Windows 10/11, Ubuntu 20.04+, macOS 10.15+
- **Python版本**: 3.8-3.11 (推荐3.10)
- **GPU**: NVIDIA GTX 1060+ (推荐RTX 3060+) 或 CPU
- **内存**: 8GB+ (推荐16GB)
- **存储**: 至少3GB可用空间 (含模型文件)
- **网络**: 稳定连接用于下载模型 (约800MB)

### 前置软件安装

#### 1. NVIDIA驱动和CUDA (Windows/Linux)
```bash
# 检查NVIDIA驱动
nvidia-smi

# 安装CUDA 11.8 (推荐版本)
# 从NVIDIA官网下载对应版本的CUDA Toolkit
```

#### 2. FFmpeg安装
```bash
# Windows (使用Chocolatey)
choco install ffmpeg

# Ubuntu
sudo apt update
sudo apt install ffmpeg

# macOS (使用Homebrew)
brew install ffmpeg

# 验证安装
ffmpeg -version
```

## 安装指南

### 方式1: Windows MSI安装包 (推荐)

#### 下载和安装
1. 下载 `AI换脸工具_v1.0.0_安装包.zip`
2. 解压到任意目录
3. 双击运行 `安装.bat`

#### 安装过程
```
[1/6] 检查Python环境...
[2/6] 准备安装目录...
[3/6] 复制程序文件...
[4/6] 检查Python依赖包...
[5/6] 创建桌面快捷方式...
[6/6] 完成安装...
```

**特点**:
- ✅ 自动检查Python环境
- ✅ 智能检测已安装的依赖
- ✅ 只安装缺失的组件
- ✅ 创建桌面快捷方式
- ✅ 支持一键卸载

#### 启动程序
- 双击桌面快捷方式 "AI换脸工具"
- 或运行安装目录中的 "启动AI换脸工具.bat"

### 方式2: 源码安装

#### 1. 克隆项目
```bash
git clone https://github.com/your-repo/ai-face-swap.git
cd ai-face-swap
```

#### 2. 创建虚拟环境 (可选)
```bash
# 创建虚拟环境
python -m venv env

# 激活虚拟环境
# Windows
.\env\Scripts\activate
# Linux/macOS
source env/bin/activate
```

#### 3. 安装依赖
```bash
# 升级pip
pip install --upgrade pip

# 安装所有依赖
pip install -r requirements.txt

# 验证安装
python scripts/check_environment.py
```

#### 4. 启动程序
```bash
# 启动GUI界面
python main_pyqt.py

# 查看命令行帮助
python main_pyqt.py --help
```

## 模型下载

### 1. 核心模型下载

#### InSwapper (换脸模型)
```bash
# 从Civitai下载 (推荐)
wget -O models/inswapper_128.onnx "https://civitai.com/api/download/models/85159"
```

#### SCRFD (人脸检测)
```bash
# 这些模型建议使用InsightFace自动下载
# 运行: python scripts/simple_model_getter.py
# 或手动从InsightFace buffalo_l模型包中复制
```

#### ArcFace (人脸识别)
```bash
# 这些模型建议使用InsightFace自动下载
# 运行: python scripts/simple_model_getter.py
# 或手动从InsightFace buffalo_l模型包中复制
```

### 2. 推荐的模型获取方式

#### 一键获取 (推荐)
```bash
# 运行简化模型获取器，自动下载所有模型
python scripts/simple_model_getter.py
```

### 3. 模型验证
```bash
# 验证模型文件完整性
python -c "
import os
models = ['inswapper_128.onnx', 'scrfd_10g_bnkps.onnx', 'arcface_r100.onnx']
for model in models:
    path = f'models/{model}'
    if os.path.exists(path):
        size = os.path.getsize(path) / (1024*1024)
        print(f'{model}: {size:.1f}MB ✓')
    else:
        print(f'{model}: 缺失 ✗')
"
```

## 基础使用

### 1. 单视频换脸
```bash
# 基础命令
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/target_video.mp4 \
    --output outputs/result.mp4 \
    --providers cuda

# 参数说明
# --source: 源脸图片路径
# --input: 目标视频路径
# --output: 输出视频路径
# --providers: 推理提供者 (cuda/cpu)
```

### 2. 批量视频处理
```bash
# 批量处理目录下所有视频
python -m dlc_batch.cli swap-dir \
    --source assets/source_face.jpg \
    --input-dir videos_in \
    --output-dir outputs \
    --providers cuda \
    --threads 2

# 参数说明
# --input-dir: 输入视频目录
# --output-dir: 输出视频目录
# --threads: 并发处理线程数
```

### 3. 实时摄像头换脸
```bash
# 实时摄像头换脸
python -m dlc_batch.cli swap-live \
    --source assets/source_face.jpg \
    --camera 0 \
    --providers cuda \
    --show-window

# 参数说明
# --camera: 摄像头设备ID (通常为0)
# --show-window: 显示预览窗口
```

## 高级功能

### 1. 多人脸处理
```bash
# 替换所有人脸
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/multi_face.mp4 \
    --output outputs/result.mp4 \
    --target all

# 仅替换最大人脸
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/multi_face.mp4 \
    --output outputs/result.mp4 \
    --target top1

# 身份映射 (不同人脸使用不同源脸)
python -m dlc_batch.cli swap-video \
    --input videos_in/multi_face.mp4 \
    --output outputs/result.mp4 \
    --map "id1=assets/face1.jpg,id2=assets/face2.jpg"
```

### 2. 画质优化选项
```bash
# 启用人脸分割和颜色匹配
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/target.mp4 \
    --output outputs/result.mp4 \
    --use-segmentation \
    --color-correction \
    --blend-ratio 0.8

# 启用图像增强 (GFPGAN)
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/target.mp4 \
    --output outputs/result.mp4 \
    --enhance-face \
    --enhance-model gfpgan
```

### 3. 性能调优参数
```bash
# 调整检测参数
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/target.mp4 \
    --output outputs/result.mp4 \
    --det-size 640 \
    --conf-threshold 0.5 \
    --min-face-size 64

# 参数说明
# --det-size: 检测输入尺寸 (越大越准确但越慢)
# --conf-threshold: 检测置信度阈值
# --min-face-size: 最小人脸尺寸 (像素)
```

## 配置说明

### 1. 配置文件 (config/default.yaml)
```yaml
# 模型配置
models:
  inswapper: "models/inswapper_128.onnx"
  detector: "models/scrfd_10g_bnkps.onnx"
  recognizer: "models/arcface_r100.onnx"
  segmentation: "models/bisenet_face.onnx"

# 检测参数
detection:
  det_size: [640, 640]
  conf_threshold: 0.5
  nms_threshold: 0.4
  min_face_size: 64

# 处理参数
processing:
  blend_ratio: 0.8
  color_correction: true
  use_segmentation: false
  enhance_face: false

# 性能参数
performance:
  providers: ["CUDAExecutionProvider", "CPUExecutionProvider"]
  batch_size: 1
  num_threads: 4
```

### 2. 环境变量配置
```bash
# 设置模型路径
export DLC_MODEL_PATH="/path/to/models"

# 设置GPU设备
export CUDA_VISIBLE_DEVICES=0

# 设置日志级别
export DLC_LOG_LEVEL=INFO
```

## 故障排除

### 1. 常见错误及解决方案

#### GPU相关问题
```bash
# 问题: CUDA不可用
# 解决: 检查CUDA安装和驱动版本
nvidia-smi
python -c "import torch; print(torch.cuda.is_available())"

# 问题: GPU内存不足
# 解决: 降低处理分辨率或批次大小
python -m dlc_batch.cli swap-video --det-size 320 --batch-size 1
```

#### 模型加载问题
```bash
# 问题: 模型文件损坏或缺失
# 解决: 重新下载模型文件
rm models/inswapper_128.onnx
wget -O models/inswapper_128.onnx [模型下载链接]

# 问题: ONNX版本不兼容
# 解决: 更新onnxruntime版本
pip install --upgrade onnxruntime-gpu
```

#### 视频处理问题
```bash
# 问题: FFmpeg编码错误
# 解决: 检查FFmpeg安装和编解码器支持
ffmpeg -codecs | grep h264

# 问题: 音轨丢失
# 解决: 确保使用正确的音轨复用命令
ffmpeg -i input.mp4 -i output_no_audio.mp4 -map 1:v -map 0:a -c copy final.mp4
```

### 2. 日志和调试
```bash
# 启用详细日志
python -m dlc_batch.cli swap-video --verbose --log-file debug.log

# 性能分析
python -m dlc_batch.cli swap-video --profile --benchmark
```

## 性能优化

### 1. GPU优化
- 使用最新的NVIDIA驱动
- 确保CUDA版本与onnxruntime-gpu兼容
- 监控GPU内存使用情况

### 2. 处理优化
- 根据硬件能力调整det_size
- 使用适当的批处理大小
- 启用多线程处理

### 3. 内存优化
- 及时释放不需要的帧数据
- 使用内存映射读取大文件
- 监控内存泄漏

### 4. 质量与速度平衡
- 高质量: det_size=640, 启用分割和增强
- 高速度: det_size=320, 禁用额外处理
- 平衡: det_size=480, 选择性启用优化

## 使用示例

### 完整工作流程示例
```bash
# 1. 准备源脸图片
cp /path/to/source_face.jpg assets/

# 2. 准备目标视频
cp /path/to/target_video.mp4 videos_in/

# 3. 执行换脸处理
python -m dlc_batch.cli swap-video \
    --source assets/source_face.jpg \
    --input videos_in/target_video.mp4 \
    --output outputs/result.mp4 \
    --providers cuda \
    --use-segmentation \
    --color-correction

# 4. 检查输出结果
ls -la outputs/
ffprobe outputs/result.mp4
```

## 注意事项

### 1. 合规使用
- 确保对所有使用的人脸图像拥有合法授权
- 仅在合规场景下使用本工具
- 遵守当地法律法规和平台政策

### 2. 数据安全
- 本工具仅在本地处理数据，不上传云端
- 建议定期清理临时文件
- 注意保护个人隐私数据

### 3. 性能建议
- 首次运行时模型加载较慢，属正常现象
- 建议在GPU环境下使用以获得最佳性能
- 大分辨率视频处理需要更多时间和资源
