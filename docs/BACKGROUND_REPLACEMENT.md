# 背景替换功能说明

## 概述

AI换脸【秘灵】现在支持背景替换功能，可以在换脸的同时替换背景，让您的创作更加丰富多彩。

## 功能特点

- 🎨 **多种替换模式**: 支持BackgroundMattingV2、MODNet、U2Net、Rembg等多种背景替换技术
- 🖼️ **灵活背景选择**: 支持单张背景图片或背景文件夹随机选择
- ⚡ **实时处理**: 与换脸功能无缝集成，一次处理完成
- 🎯 **高质量输出**: 保持人物边缘细节，自然融合背景

## 支持的背景替换模式

### 1. BackgroundMattingV2 (推荐)
- **特点**: 高质量背景替换，保留头发丝等细节
- **适用**: 人像照片和视频
- **性能**: 中等速度，高质量

### 2. MODNet (快速)
- **特点**: 快速人像分割，实时性好
- **适用**: 实时处理场景
- **性能**: 高速度，中等质量

### 3. U2Net (通用)
- **特点**: 通用目标分割，不仅限于人像
- **适用**: 各种目标对象
- **性能**: 中等速度，中等质量

### 4. Rembg (简单)
- **特点**: 简单易用，安装方便
- **适用**: 快速背景移除
- **性能**: 快速，质量较好

## 安装依赖

### 自动安装
```bash
python scripts/install_background_deps.py
```

### 手动安装
```bash
# 基础依赖
pip install rembg[new]>=2.0.50
pip install Pillow>=10.0.0

# GPU加速 (可选)
pip install torch>=1.13.0
pip install torchvision>=0.14.0
pip install onnxruntime-gpu>=1.15.0
```

## 使用方法

### GUI界面使用

1. **启用背景替换**
   - 在文件选择区域勾选"启用背景替换"

2. **选择替换模式**
   - 从下拉菜单中选择背景替换模式
   - 推荐使用"BackgroundMattingV2"获得最佳效果

3. **选择背景来源**
   - **单张图片**: 点击"选择图片"选择一张背景图片
   - **文件夹**: 点击"选择文件夹"选择包含多张背景图片的文件夹

4. **开始处理**
   - 确保已选择源人脸、目标文件和输出路径
   - 点击"开始换脸"进行处理

### 背景图片要求

- **格式**: 支持 JPG、JPEG、PNG、BMP、TIFF
- **尺寸**: 建议与目标图片/视频尺寸相近
- **质量**: 高分辨率图片效果更好

## 处理流程

1. **人脸检测**: 检测源图片和目标图片/视频中的人脸
2. **换脸处理**: 使用AI技术进行人脸替换
3. **背景分割**: 使用选定的模式分离前景和背景
4. **背景替换**: 将新背景与前景人物合成
5. **输出保存**: 保存最终结果

## 性能优化建议

### GPU加速
- 安装CUDA版本的依赖包获得更好性能
- 确保GPU内存充足（建议4GB以上）

### 处理设置
- 对于视频处理，建议使用较快的模式（MODNet或Rembg）
- 对于图片处理，可以使用高质量模式（BackgroundMattingV2）

### 背景图片优化
- 使用高质量的背景图片
- 背景图片尺寸与目标文件匹配
- 避免过于复杂的背景图案

## 故障排除

### 常见问题

**Q: 背景替换功能无法使用？**
A: 请确保已安装相关依赖，运行 `python scripts/install_background_deps.py`

**Q: 处理速度很慢？**
A: 尝试切换到更快的模式（MODNet或Rembg），或安装GPU加速版本

**Q: 背景替换效果不好？**
A: 尝试使用BackgroundMattingV2模式，或更换高质量的背景图片

**Q: 内存不足错误？**
A: 降低处理分辨率，或使用更轻量的模式（Rembg）

### 错误代码

- `背景替换模型初始化失败`: 检查依赖安装
- `无法读取背景图片`: 检查图片格式和路径
- `背景替换失败，使用原图`: 模型处理出错，检查输入图片

## 技术原理

### 背景分割技术
- **语义分割**: 使用深度学习模型识别图像中的不同区域
- **边缘优化**: 特殊算法处理人物边缘，保持自然效果
- **颜色匹配**: 自动调整前景和背景的色彩平衡

### 模型架构
- **U2Net**: 基于U-Net的深度网络，专门用于显著性目标检测
- **MODNet**: 轻量级实时人像分割网络
- **BackgroundMattingV2**: 高质量背景抠图网络

## 更新日志

### v1.0.0
- 添加基础背景替换功能
- 支持4种背景替换模式
- 集成到GUI界面
- 支持图片和视频处理

## 贡献

欢迎提交Issue和Pull Request来改进背景替换功能！

## 许可证

本功能遵循项目主许可证，仅供学习和研究使用。
